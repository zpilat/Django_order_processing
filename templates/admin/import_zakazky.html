{% extends "admin/base_site.html" %}
{% load custom_filters%}

{% block extrahead %}
  {{ block.super }}
  <style>
    /* secondary button look close to admin */
    .btn-secondary { background: #f3f4f6; border: 1px solid #d1d5db; color: #111827; border-radius: 4px; padding: 9px 12px; }
    .btn-secondary:hover { background: #e5e7eb; }
  </style>
{% endblock%}

{% block content %}
<div id="content" class="flex">
  {% if messages %}
    <ul class="messagelist">
      {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if errors %}
    <ul class="errorlist">
      {% for err in errors %}
        <li>{{ err }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if warnings %}
    <ul class="messagelist">
      {% for w in warnings %}
        <li class="warning">{{ w }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" enctype="multipart/form-data" novalidate>
  {% csrf_token %}
  <input type="hidden" name="preview" id="id_preview" value="" />
  {% if tmp_token %}
    <input type="hidden" name="tmp_token" value="{{ tmp_token }}" />
  {% endif %}
  <div class="module aligned">
      <fieldset class="module aligned">
      <div class="form-row">
          {{ form.file.errors }}
          <label for="{{ form.file.id_for_label }}">{{ form.file.label }}</label>
          <span style="display:flex;gap:20px;align-items:center;">
            {{ form.file|add_class:"vTextField" }}
            {% if tmp_filename %}
              <span class="help">Vybraný soubor: <strong>{{ tmp_filename }}</strong> (ponecháte-li prázdné, použije se tento)</span>
            {% endif %}
          </span>
      </div>
      </fieldset>
  </div>

  <div class="submit-row">
  <input type="submit" value="Importovat" class="default">
  </div>
  </form>

  <script>
    (function () {
      const form = document.querySelector('form');
      const fileInput = document.getElementById('{{ form.file.id_for_label }}');
      const previewField = document.getElementById('id_preview');
      if (!form || !fileInput || !previewField) return;

      let autoSubmit = false;

      fileInput.addEventListener('change', function () {
        if (!fileInput.files || fileInput.files.length === 0) return;
        previewField.value = '1';
        autoSubmit = true;
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else {
          form.submit();
        }
      });

      form.addEventListener('submit', function () {
        if (autoSubmit) {
          autoSubmit = false;
          return;
        }
        previewField.value = '';
      });
    })();
  </script>

  {% if preview %}
    <h3>Náhled importu (max. 50 řádků)</h3>
    <div class="results">
      <table id="result_list">
        {% for row in preview %}
          {% if forloop.first %}    
            <thead>
              <tr>
                {% if row.datum %}
                  <th scope="col">Datum</th>
                {% endif %}
                {% if row.behalter_nr %}
                  <th scope="col">Číslo bedny</th>
                {% endif %}
                <th scope="col">Artikl</th>
                <th scope="col">Ø</th>
                <th scope="col">Délka</th>
                <th scope="col">Výrobní zakázka</th>
                {% if row.predpis %}
                  <th scope="col">Předpis</th>
                {% endif %}
                {% if row.typ_hlavy %}
                  <th scope="col">Typ hlavy</th>
                {% endif %}
                <th scope="col">Popis</th>
                {% if row.material %}
                  <th scope="col">Materiál</th>
                {% endif %}
                {% if row.sarze %}
                  <th scope="col">Šarže</th>
                {% endif %}
                {% if row.vrstva %}
                  <th scope="col">Vrstva</th>
                {% endif %}
                {% if row.povrch %}
                  <th scope="col">Povrch</th>
                {% endif %}
                <th scope="col">Množství (ks)</th>            
                <th scope="col">Hmotnost (kg)</th>
                <th scope="col">Tára (kg)</th>
              </tr>
            </thead>
            <tbody>            
          {% endif %}
            <tr>
              {% if row.datum %}
                <td>{{ row.datum }}</td>
              {% endif %}
              {% if row.behalter_nr %}
                <td>{{ row.behalter_nr }}</td>
              {% endif %}
              <td>{{ row.artikl }}</td>
              <td style="text-align: center;">{{ row.prumer }}</td>
              <td style="text-align: center;">{{ row.delka }}</td>
              <td>{{ row.vyrobni_zakazka }}</td>
              {% if row.predpis %}
                <td>{{ row.predpis }}</td>
              {% endif %}
              {% if row.typ_hlavy %}
                <td>{{ row.typ_hlavy }}</td>
              {% endif %}
              <td>{{ row.popis }}</td>
              {% if row.material %}
                <td>{{ row.material }}</td>
              {% endif %}
              {% if row.sarze %}
                <td>{{ row.sarze }}</td>
              {% endif %}
              {% if row.vrstva %}
                <td>{{ row.vrstva }}</td>
              {% endif %}
              {% if row.povrch %}
                <td>{{ row.povrch }}</td>
              {% endif %}
              <td style="text-align: center;">{{ row.mnozstvi }}</td>
              <td style="text-align: center;">{{ row.hmotnost }}</td>
              <td style="text-align: center;">{{ row.tara }}</td>
            </tr>
          {% endfor %}        
        </tbody>
      </table>
    </div>
  {% endif %}
</div>
{% endblock %}

