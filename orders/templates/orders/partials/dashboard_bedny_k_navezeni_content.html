{% load custom_filters %}

<div class="row flex-nowrap overflow-auto">
  <div id="knavezeni-dashboard" class="col-xxl-5 col-xl-6 col-lg-8 col-md-10 col-sm-12 mb-4">
    <div class="alert" role="alert" style="background-color: #214290; color: #ffde17; font-family: 'Liberation Sans', Arial;">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="mb-0">Přehled beden k navezení</h3>
        <a class="btn btn-secondary" style="color: #ffde17;" href="{% url 'admin:orders_bedna_changelist' %}">Návrat</a>
      </div>
      <h6>Naposledy aktualizováno: {{ current_time|date:"d.m.Y H:i" }}</h6>
    </div>    
    <table class="table table-sm align-middle mb-0 text-center">
      <thead>
        <tr style="font-size: 1.5rem;">
          <th colspan="5" class="fw-bold" style="background-color: #ffde17; color: #214290;">Bedny k navezení</th>
        </tr>
      </thead>
      <tbody>      
        {% if groups %}
          {% for group in groups %}
            <tr>
              <th colspan="5" style="background-color: #ffde17; color: #214290; font-size: 1.2rem;">Do pozice: {{ group.pozice }}</th>
            </tr>
            <tr>
              <th style="background-color: #214290; color: #ffde17;">Artikl</th>
              <th style="background-color: #214290; color: #ffde17;">Rozměr</th>
              <th style="background-color: #214290; color: #ffde17;">Popis</th>
              <th style="background-color: #214290; color: #ffde17;">Poznámka k navezení</th>
              <th style="background-color: #214290; color: #ffde17;">Číslo bedny</th>          
            </tr>          
            {% for zakazka_group in group.zakazky_group %}
              {% with zg_index=forloop.counter0 zg_last=forloop.last %}
              {% for bedna in zakazka_group.bedny %}
                {% if forloop.first %}
                  <tr style="border-top: 2px solid #214290;">
                {% else %}
                  <tr>
                {% endif %}
                  {% if forloop.first %}
                    <td rowspan="{{ zakazka_group.bedny|length }}">
                      <div class="d-flex flex-column align-items-start gap-1">
                        <div class="fw-bold">{{ zakazka_group.zakazka.artikl }}</div>
                        <div class="d-flex align-items-center gap-1">
                          <!-- Zobrazit pouze pro ladění aktuálního pořadí v pozici -->
                          <!--<span class="text-muted">{{ zakazka_group.poradi|default:0 }}</span>-->
                          {% if group.pozice != pozice_kody|first or zg_index > 0 %}
                            <form method="post" action="{% url 'dashboard_bedny_k_navezeni' %}">
                              {% csrf_token %}
                              <input type="hidden" name="pozice_id" value="{{ zakazka_group.pozice_id }}" />
                              <input type="hidden" name="zakazka_id" value="{{ zakazka_group.zakazka.id }}" />
                              <input type="hidden" name="move" value="up" />
                              <button type="submit" class="btn btn-sm btn-outline-primary"
                                title="{% if zg_index > 0 %}Posunout výš{% else %}Posunout do předcházející pozice: {{ prev_map|dict_get:group.pozice }}{% endif %}">▲</button>
                            </form>
                          {% endif %}
                          {% if group.pozice != pozice_kody|last or not zg_last %}
                            <form method="post" action="{% url 'dashboard_bedny_k_navezeni' %}">
                              {% csrf_token %}
                              <input type="hidden" name="pozice_id" value="{{ zakazka_group.pozice_id }}" />
                              <input type="hidden" name="zakazka_id" value="{{ zakazka_group.zakazka.id }}" />
                              <input type="hidden" name="move" value="down" />
                              <button type="submit" class="btn btn-sm btn-outline-primary"
                              title="{% if not zg_last %}Posunout níž{% else %}Posunout do následující pozice: {{ next_map|dict_get:group.pozice }}{% endif %}">▼</button>
                            </form>
                          {% endif %}
                        </div>
                      </div>
                    </td>
                    <td rowspan="{{ zakazka_group.bedny|length }}">{{ zakazka_group.zakazka.prumer }} x {{ zakazka_group.zakazka.delka }}</td>
                    <td rowspan="{{ zakazka_group.bedny|length }}">{{ zakazka_group.zakazka.popis }}</td>          
                    <td rowspan="{{ zakazka_group.bedny|length }}">
                      {% with bedna_first=zakazka_group.bedny|first %}
                        {% with poz=zakazka_group.pozice_id|stringformat:"s" zak=zakazka_group.zakazka.id|stringformat:"s" %}
                          {% with target_id="note-"|add:poz|add:"-"|add:zak %}
                            <div id="{{ target_id }}">
                              <button type="button" class="btn btn-sm btn-outline-secondary w-100"
                                hx-get="{% url 'dashboard_bedny_k_navezeni_poznamka' %}?pozice_id={{ zakazka_group.pozice_id }}&zakazka_id={{ zakazka_group.zakazka.id }}&mode=form"
                                hx-target="#{{ target_id }}" hx-swap="outerHTML">
                                {{ bedna_first.poznamka_k_navezeni|default:"vše" }}
                              </button>
                            </div>
                          {% endwith %}
                        {% endwith %}
                      {% endwith %}
                    </td>                              
                  {% endif %}
                  <td>{{ bedna.cislo_bedny }}</td>
                </tr>
              {% endfor %}
              {% endwith %}
            {% endfor %}
          {% endfor %}
        {% else %}
          <tr>
            <th colspan="5" style="background-color: #ffde17; color: #214290;">Žádné bedny ve stavu K_NAVEZENI.</th>
          </tr>
        {% endif %}
      </tbody>
    </table><br>     
    <div class="mb-2" style="text-align: center; display: flex; gap: 8px; justify-content: center;">
      <a href="{% url 'dashboard_bedny_k_navezeni_pdf' %}" target="_blank" style="background:#214290;color:#fff;border:1px solid #1b387a;border-radius:4px;padding:6px 12px;text-decoration:none;display:inline-block;">
        Tisk do PDF
      </a>
    </div>    
  </div>
</div> 
